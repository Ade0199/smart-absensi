<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<title>AdeSosial X ‚ö°</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="manifest" href="manifest.json">

<!-- FIREBASE CDN -->
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-storage-compat.js"></script>

<style>
body{font-family:sans-serif;background:#111;color:#fff;margin:0}
header{padding:15px;background:#000;text-align:center;font-size:20px}
input,textarea,button{width:100%;margin:5px 0;padding:10px;border-radius:8px;border:none}
button{background:#0af;color:#000;font-weight:bold}
.post{background:#1c1c1c;margin:10px;padding:10px;border-radius:12px}
img{width:100%;border-radius:10px}
small{color:#aaa}
.like{cursor:pointer;color:#0af}
</style>
</head>

<body>

<header>AdeSosial X ‚ö°</header>

<div id="auth">
  <input id="email" placeholder="Email">
  <input id="password" type="password" placeholder="Password">
  <button onclick="login()">Login / Daftar</button>
</div>

<div id="app" style="display:none;padding:10px">
  <input type="file" id="photo">
  <textarea id="caption" placeholder="Apa yang kamu pikirkan?"></textarea>
  <button onclick="post()">Posting</button>

  <h3>üî• Feed</h3>
  <div id="feed"></div>

  <h3>üí¨ Chat Global</h3>
  <div id="chat"></div>
  <input id="msg" placeholder="Tulis pesan...">
  <button onclick="sendChat()">Kirim</button>
</div>

<script>
/* ================= FIREBASE INIT ================= */
firebase.initializeApp({
  apiKey: "AIzaSyCRldMRUuy7NqIMbJUCKSbPUlFyXgREn4w",
  authDomain: "adesosial-x.firebaseapp.com",
  projectId: "adesosial-x",
  storageBucket: "adesosial-x.firebasestorage.app",
  messagingSenderId: "549966673845",
  appId: "1:549966673845:web:d85794b0d840d2209e0bfc"
});

const auth = firebase.auth();
const db = firebase.firestore();
const storage = firebase.storage();

/* ================= AUTH ================= */
function login(){
  auth.signInWithEmailAndPassword(email.value,password.value)
  .catch(()=>auth.createUserWithEmailAndPassword(email.value,password.value));
}

auth.onAuthStateChanged(u=>{
  if(u){
    auth.style.display="none";
    app.style.display="block";
  }
});

/* ================= POST ================= */
async function post(){
  const file=photo.files[0];
  if(!file) return alert("Pilih foto");
  const ref=storage.ref("posts/"+Date.now());
  await ref.put(file);
  const url=await ref.getDownloadURL();

  db.collection("posts").add({
    user:auth.currentUser.email,
    img:url,
    caption:caption.value,
    likes:0,
    time:firebase.firestore.FieldValue.serverTimestamp()
  });

  caption.value="";
}

/* ================= FEED + ALGORITMA ================= */
db.collection("posts")
.orderBy("time","desc")
.onSnapshot(snap=>{
  feed.innerHTML="";
  snap.forEach(doc=>{
    const p=doc.data();
    feed.innerHTML+=`
    <div class="post">
      <img src="${p.img}">
      <p><b>${p.user}</b></p>
      <p>${p.caption}</p>
      <p class="like" onclick="like('${doc.id}',${p.likes})">
        ‚ù§Ô∏è ${p.likes}
      </p>
      <small>${p.time?.toDate()}</small>
    </div>`;
  });
});

/* ================= LIKE ================= */
function like(id,count){
  db.collection("posts").doc(id).update({
    likes:count+1
  });
}

/* ================= CHAT REALTIME ================= */
function sendChat(){
  db.collection("chat").add({
    user:auth.currentUser.email,
    msg:msg.value,
    time:firebase.firestore.FieldValue.serverTimestamp()
  });
  msg.value="";
}

db.collection("chat")
.orderBy("time")
.onSnapshot(snap=>{
  chat.innerHTML="";
  snap.forEach(d=>{
    const c=d.data();
    chat.innerHTML+=`<p><b>${c.user}:</b> ${c.msg}</p>`;
  });
});

/* ================= PWA ================= */
if("serviceWorker" in navigator){
  navigator.serviceWorker.register("service-worker.js");
}
</script>
</body>
</html>
