<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<title>AdeSosial X</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<style>
body{margin:0;font-family:Arial;background:#000;color:#fff}
input,textarea,button{width:100%;padding:10px;margin-top:8px;border-radius:8px;border:none}
button{background:#0095f6;color:#fff;font-weight:bold}
#loginPage{height:100vh;display:flex;justify-content:center;align-items:center}
.login-box{width:90%;max-width:360px;background:#111;padding:20px;border-radius:12px}
#app{display:none}
header{background:#000;padding:12px;display:flex;justify-content:space-between;border-bottom:1px solid #222}
nav{position:fixed;bottom:0;width:100%;background:#000;display:flex;justify-content:space-around;border-top:1px solid #222}
nav button{background:none;font-size:20px}
#page{padding:10px;margin-bottom:70px}
.post{background:#111;margin-bottom:12px;border-radius:12px;padding:10px}
.post img{width:100%;border-radius:10px}
.like-btn{background:none;color:#ff4444;font-size:18px}
.user-link{color:#4da3ff;cursor:pointer}

/* STORY */
.story-bar{display:flex;overflow-x:auto;margin-bottom:10px}
.story{width:70px;text-align:center;margin-right:10px}
.story img{width:60px;height:60px;border-radius:50%;border:2px solid #ff00ff}

/* COMMENT */
.comment{font-size:14px;border-top:1px solid #222;padding:4px}

/* CHAT */
.chat-box{height:60vh;overflow-y:auto}
.chat-me{text-align:right}
.chat-me span{background:#0095f6;padding:8px;border-radius:10px;display:inline-block;margin:4px}
.chat-other{text-align:left}
.chat-other span{background:#333;padding:8px;border-radius:10px;display:inline-block;margin:4px}
</style>
</head>

<body>

<div id="loginPage">
  <div class="login-box">
    <h2 style="text-align:center">AdeSosial X</h2>
    <input id="email" placeholder="Email">
    <input id="password" type="password" placeholder="Password">
    <button onclick="login()">Login</button>
    <button onclick="register()" style="background:#333">Daftar</button>
  </div>
</div>

<div id="app">
  <header>
    <b>AdeSosial X</b>
    <button onclick="logout()" style="background:red">Logout</button>
  </header>

  <div id="page"></div>

  <nav>
    <button onclick="showFeed()">üè†</button>
    <button onclick="showChat()">üí¨</button>
    <button onclick="showProfile(auth.currentUser.email)">üë§</button>
  </nav>
</div>

<script>
firebase.initializeApp({
  apiKey:"AIzaSyCRldMRUuy7NqIMbJUCKSbPUlFyXgREn4w",
  authDomain:"adesosial-x.firebaseapp.com",
  projectId:"adesosial-x"
});
const auth=firebase.auth();
const db=firebase.firestore();

/* AUTH */
function login(){auth.signInWithEmailAndPassword(email.value,password.value).catch(e=>alert(e.message))}
function register(){auth.createUserWithEmailAndPassword(email.value,password.value).catch(e=>alert(e.message))}
function logout(){auth.signOut()}

auth.onAuthStateChanged(u=>{
  if(u){loginPage.style.display="none";app.style.display="block";showFeed()}
  else{app.style.display="none";loginPage.style.display="flex"}
});

/* FEED + STORY */
function showFeed(){
  page.innerHTML=`
    <div class="story-bar" id="stories"></div>

    <input type="file" id="storyFile">
    <button onclick="postStory()">Tambah Story</button>

    <input type="file" id="photo">
    <textarea id="caption" placeholder="Apa yang kamu pikirkan?"></textarea>
    <button onclick="post()">Posting</button>

    <div id="feed"></div>`;
  loadStories();
  loadFeed();
}

/* STORY 24 JAM */
function postStory(){
  const f=storyFile.files[0];
  if(!f)return;
  const fd=new FormData();
  fd.append("file",f);
  fd.append("upload_preset","adesosial_unsigned");
  fetch("https://api.cloudinary.com/v1_1/da50sezv7/image/upload",{method:"POST",body:fd})
  .then(r=>r.json()).then(d=>{
    db.collection("stories").add({
      img:d.secure_url,
      user:auth.currentUser.email,
      time:Date.now()
    });
  });
}

function loadStories(){
  const limit=Date.now()-86400000;
  db.collection("stories").where("time",">",limit)
  .onSnapshot(s=>{
    stories.innerHTML="";
    s.forEach(d=>{
      const st=d.data();
      stories.innerHTML+=`
        <div class="story" onclick="viewStory('${st.img}')">
          <img src="${st.img}">
        </div>`;
    });
  });
}

function viewStory(img){
  page.innerHTML=`<img src="${img}" style="width:100%">`;
}

/* POST */
function post(){
  const f=photo.files[0];
  if(!f)return alert("Pilih foto");
  const fd=new FormData();
  fd.append("file",f);
  fd.append("upload_preset","adesosial_unsigned");
  fetch("https://api.cloudinary.com/v1_1/da50sezv7/image/upload",{method:"POST",body:fd})
  .then(r=>r.json()).then(d=>{
    db.collection("posts").add({
      img:d.secure_url,
      caption:caption.value,
      user:auth.currentUser.email,
      likes:0,
      time:Date.now()
    });
    caption.value="";
  });
}

function loadFeed(){
  db.collection("posts").orderBy("time","desc")
  .onSnapshot(s=>{
    feed.innerHTML="";
    s.forEach(doc=>{
      const p=doc.data();
      feed.innerHTML+=`
        <div class="post">
          <p class="user-link">@${p.user}</p>
          <img src="${p.img}">
          <p>${p.caption}</p>
          <button class="like-btn" onclick="like('${doc.id}',${p.likes})">‚ù§Ô∏è ${p.likes}</button>
          <div id="c-${doc.id}"></div>
          <input placeholder="Komentar..." onkeydown="addComment(event,'${doc.id}')">
        </div>`;
      loadComments(doc.id);
    });
  });
}

function like(id,c){db.collection("posts").doc(id).update({likes:c+1})}

/* COMMENT REALTIME */
function addComment(e,id){
  if(e.key==="Enter"){
    db.collection("posts").doc(id)
    .collection("comments").add({
      user:auth.currentUser.email,
      text:e.target.value,
      time:Date.now()
    });
    e.target.value="";
  }
}
function loadComments(id){
  db.collection("posts").doc(id)
  .collection("comments").orderBy("time")
  .onSnapshot(s=>{
    const box=document.getElementById("c-"+id);
    box.innerHTML="";
    s.forEach(d=>{
      const c=d.data();
      box.innerHTML+=`<div class="comment"><b>${c.user}</b>: ${c.text}</div>`;
    });
  });
}

/* CHAT */
function showChat(){
  page.innerHTML=`
    <div class="chat-box" id="chatBox"></div>
    <input id="chatMsg" placeholder="Tulis pesan...">
    <button onclick="sendChat()">Kirim</button>`;
  db.collection("chats").orderBy("time").onSnapshot(s=>{
    chatBox.innerHTML="";
    s.forEach(d=>{
      const c=d.data();
      const me=c.user===auth.currentUser.email;
      chatBox.innerHTML+=`
        <div class="${me?'chat-me':'chat-other'}">
          <span>${c.msg}</span>
        </div>`;
    });
    chatBox.scrollTop=chatBox.scrollHeight;
  });
}
function sendChat(){
  if(!chatMsg.value)return;
  db.collection("chats").add({
    msg:chatMsg.value,
    user:auth.currentUser.email,
    time:Date.now()
  });
  chatMsg.value="";
}
</script>
</body>
</html>
